---
stages:
  - lint
  - build

lint:
  stage: lint
  image: koalaman/shellcheck-alpine:stable
  before_script:
    - shellcheck --version
  script:
    - grep -rlE '^#!/bin/(ba)?sh' . | xargs shellcheck

.build:
  stage: build
  image:
    name: moby/buildkit:latest
    entrypoint: [""]
  before_script:
    - mkdir -p ~/.docker
    - AUTH=$(echo -n "${CI_REGISTRY_USER}:${CI_REGISTRY_PASSWORD}" | base64)
    - echo "{\"auths\":{\"${CI_REGISTRY}\":{\"auth\":\"${AUTH}\"}}}" > ~/.docker/config.json
  script:
    - buildctl-daemonless.sh build
      --frontend=dockerfile.v0
      --local context=${TARGET}
      --local dockerfile=${TARGET}
      --output type=image,name=${CI_REGISTRY_IMAGE}/${TARGET}:${CI_COMMIT_REF_NAME},push=true

builder:
  extends: .build
  variables:
    TARGET: builder

alpine:
  extends: .build
  variables:
    TARGET: alpine
